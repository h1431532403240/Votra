# CI Workflow for Votra
# Purpose: Build, test, and lint PRs without code signing
# Environment: macos-26 runner (Apple Silicon), Xcode 26
# Target: macOS 26.0+ (Tahoe), Apple Silicon only — FoundationModels/Translation APIs require Neural Engine
# Transparency: All logs publicly visible on GitHub Actions tab
# Cost: FREE for public repositories

name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

# Concurrency: Cancel in-progress runs for same PR
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  build-and-test:
    name: Build and Test
    runs-on: macos-26
    timeout-minutes: 15

    steps:
      # 1. Checkout with full history for gitleaks
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Select Xcode version
      # Note: macos-26 runners have Xcode 26 pre-installed at /Applications/Xcode.app
      - name: Select Xcode
        run: |
          # List available Xcode versions for debugging
          ls -la /Applications/ | grep -i xcode || true
          # Use default Xcode.app (Xcode 26 on macos-26 runners)
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version

      # 3. Cache SPM dependencies (if any)
      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            .build
          key: spm-${{ runner.os }}-${{ hashFiles('**/Package.resolved') }}

      # 4. Secret Scanning (FR-013)
      - name: Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 5. SwiftLint (FR-007: --strict ensures exit code is non-zero on any violation)
      - name: SwiftLint
        run: |
          set -euo pipefail
          brew install swiftlint
          swiftlint lint --strict

      # 6. Build (no code signing for CI)
      # Uses Votra-CI scheme which only includes unit tests (no UI tests)
      - name: Build
        run: |
          set -euo pipefail
          xcodebuild build \
            -project Votra.xcodeproj \
            -scheme Votra-CI \
            -destination 'platform=macOS,arch=arm64' \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

      # 7. Run unit tests
      # Uses -skip-testing-tags to skip audio hardware tests
      # Monitors stdout for test completion and terminates (avoids HALC cleanup hang)
      - name: Test
        run: |
          # Run xcodebuild with output to log file
          xcodebuild test \
            -project Votra.xcodeproj \
            -scheme Votra-CI \
            -destination 'platform=macOS,arch=arm64' \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            -skip-testing-tags requiresHardware \
            -resultBundlePath TestResults.xcresult > /tmp/xcodebuild.log 2>&1 &
          XCODE_PID=$!

          # Monitor log file for test completion
          test_result=""
          last_test_time=0
          while kill -0 $XCODE_PID 2>/dev/null; do
            # Check for test completion patterns
            # XCTest: "Test Suite 'All tests' passed"
            # Swift Testing: Final suite pass or "✔ Test" messages followed by no activity
            if grep -q "Test Suite 'All tests' passed" /tmp/xcodebuild.log 2>/dev/null; then
              # XCTest completed, now wait for Swift Testing
              # Look for HALC messages which indicate test cleanup phase
              if grep -q "HALC_ShellObject" /tmp/xcodebuild.log 2>/dev/null; then
                echo "✓ Tests completed, HALC cleanup detected - terminating"
                test_result="passed"
                break
              fi
            fi

            # Also check for explicit failure
            if grep -q "\*\* TEST FAILED \*\*" /tmp/xcodebuild.log 2>/dev/null; then
              test_result="failed"
              echo "✗ Tests failed"
              break
            fi

            # Check for explicit success (XCTest style)
            if grep -q "\*\* TEST SUCCEEDED \*\*" /tmp/xcodebuild.log 2>/dev/null; then
              test_result="passed"
              echo "✓ Tests passed"
              break
            fi

            sleep 5
          done

          # Show last part of log for debugging
          echo "=== Last 50 lines of test output ==="
          tail -50 /tmp/xcodebuild.log

          # Cleanup: kill xcodebuild
          kill $XCODE_PID 2>/dev/null || true
          sleep 2
          kill -9 $XCODE_PID 2>/dev/null || true

          # If we didn't detect result yet, check the log file
          if [ -z "$test_result" ]; then
            if grep -q "Test Suite 'All tests' passed" /tmp/xcodebuild.log 2>/dev/null; then
              test_result="passed"
            fi
          fi

          # Exit based on test result
          if [ "$test_result" = "passed" ]; then
            exit 0
          else
            exit 1
          fi

      # 8. Upload test results
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResults.xcresult
          retention-days: 7

# Expected outputs:
# - Build succeeds (exit 0)
# - All tests pass (2766 unit tests)
# - SwiftLint clean (no violations)
# - Test results artifact uploaded
