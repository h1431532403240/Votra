# CI Workflow for Votra
# Purpose: Build, test, and lint PRs without code signing
# Environment: macos-26 runner (Apple Silicon), Xcode 26
# Target: macOS 26.0+ (Tahoe), Apple Silicon only â€” FoundationModels/Translation APIs require Neural Engine
# Transparency: All logs publicly visible on GitHub Actions tab
# Cost: FREE for public repositories

name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

# Concurrency: Cancel in-progress runs for same PR
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  build-and-test:
    name: Build and Test
    runs-on: macos-26
    timeout-minutes: 15

    steps:
      # 1. Checkout with full history for gitleaks
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Select Xcode version
      # Note: macos-26 runners have Xcode 26 pre-installed at /Applications/Xcode.app
      - name: Select Xcode
        run: |
          # List available Xcode versions for debugging
          ls -la /Applications/ | grep -i xcode || true
          # Use default Xcode.app (Xcode 26 on macos-26 runners)
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version

      # 3. Cache SPM dependencies (if any)
      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            .build
          key: spm-${{ runner.os }}-${{ hashFiles('**/Package.resolved') }}

      # 4. Secret Scanning (FR-013)
      - name: Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 5. SwiftLint (FR-007: --strict ensures exit code is non-zero on any violation)
      - name: SwiftLint
        run: |
          set -euo pipefail
          brew install swiftlint
          swiftlint lint --strict

      # 6. Build (no code signing for CI)
      # Uses Votra-CI scheme which only includes unit tests (no UI tests)
      - name: Build
        run: |
          set -euo pipefail
          xcodebuild build \
            -project Votra.xcodeproj \
            -scheme Votra-CI \
            -destination 'platform=macOS,arch=arm64' \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

      # 7. Run unit tests
      # Uses Votra-CI scheme which excludes VotraUITests (requires code signing)
      - name: Test
        run: |
          set -euo pipefail
          xcodebuild test \
            -project Votra.xcodeproj \
            -scheme Votra-CI \
            -destination 'platform=macOS,arch=arm64' \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            -resultBundlePath TestResults.xcresult

      # 8. Upload test results
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResults.xcresult
          retention-days: 7

# Expected outputs:
# - Build succeeds (exit 0)
# - All tests pass (2766 unit tests)
# - SwiftLint clean (no violations)
# - Test results artifact uploaded
