# Release Workflow for Votra
# Purpose: Build, sign, notarize, create DMG, publish to GitHub Releases
# Environment: macos-26 runner (Apple Silicon), Xcode 26
# Target: macOS 26.0+ (Tahoe), Apple Silicon only â€” FoundationModels/Translation APIs require Neural Engine
# Transparency: All logs publicly visible on GitHub Actions tab
#
# Secrets Required (stored in GitHub Secrets):
#   - DEVELOPER_CERTIFICATE_P12: Developer ID Application certificate (base64)
#   - DEVELOPER_CERTIFICATE_PASSWORD: Password for .p12 file
#   - KEYCHAIN_PASSWORD: Temporary keychain password
#   - APPLE_TEAM_ID: Apple Developer Team ID
#   - NOTARY_KEY_ID: App Store Connect API Key ID
#   - NOTARY_ISSUER_ID: App Store Connect Issuer ID
#   - NOTARY_KEY_P8: API Key .p8 file content (base64)

name: Release

on:
  push:
    tags: ['v*.*.*']

# No concurrency - releases should not be cancelled
permissions:
  contents: write  # Required for creating releases

env:
  SCHEME: 'Votra'
  PROJECT: 'Votra.xcodeproj'

jobs:
  build-and-release:
    name: Build, Sign, Notarize, and Release
    runs-on: macos-26
    timeout-minutes: 45

    steps:
      # 1. Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Extract version from tag
      - name: Extract Version
        id: version
        run: |
          set -euo pipefail
          VERSION=${GITHUB_REF_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "dmg_name=Votra-$VERSION.dmg" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      # 3. Select Xcode
      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version

      # 4. SwiftLint (gate - fail fast on lint errors)
      - name: SwiftLint
        run: |
          set -euo pipefail
          brew install swiftlint
          swiftlint lint --strict || {
            echo "::error::SwiftLint found violations. Fix them before releasing."
            exit 1
          }

      # Note: Tests are validated in CI workflow before merge
      # Release workflow focuses on building, signing, and notarizing

      # 5. Setup code signing keychain
      - name: Setup Keychain
        env:
          DEVELOPER_CERTIFICATE_P12: ${{ secrets.DEVELOPER_CERTIFICATE_P12 }}
          DEVELOPER_CERTIFICATE_PASSWORD: ${{ secrets.DEVELOPER_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          set -euo pipefail

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain || {
            echo "::error::Failed to create keychain."
            exit 1
          }
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

          # Import certificate
          echo -n "$DEVELOPER_CERTIFICATE_P12" | base64 --decode -o certificate.p12
          security import certificate.p12 -k build.keychain \
            -P "$DEVELOPER_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign || {
            rm -f certificate.p12
            echo "::error::Failed to import certificate. Check DEVELOPER_CERTIFICATE_P12 and password."
            exit 1
          }
          rm -f certificate.p12

          # Allow codesign access
          security set-key-partition-list -S apple-tool:,apple: \
            -k "$KEYCHAIN_PASSWORD" build.keychain

          echo "âœ… Keychain setup complete"

      # 6. Build Release Archive
      - name: Build Archive
        run: |
          set -euo pipefail
          xcodebuild archive \
            -project ${{ env.PROJECT }} \
            -scheme ${{ env.SCHEME }} \
            -archivePath build/Votra.xcarchive \
            -configuration Release \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" || {
            echo "::error::Failed to create archive."
            exit 1
          }
          echo "âœ… Archive created successfully"

      # 7. Export App
      - name: Export App
        run: |
          set -euo pipefail
          cat > ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>developer-id</string>
            <key>teamID</key>
            <string>${{ secrets.APPLE_TEAM_ID }}</string>
            <key>signingStyle</key>
            <string>automatic</string>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath build/Votra.xcarchive \
            -exportPath build/export \
            -exportOptionsPlist ExportOptions.plist || {
            echo "::error::Failed to export archive."
            exit 1
          }

          rm ExportOptions.plist
          echo "âœ… App exported successfully"

      # 8. Setup Notarization Credentials
      - name: Setup Notarization
        env:
          NOTARY_KEY_P8: ${{ secrets.NOTARY_KEY_P8 }}
          NOTARY_KEY_ID: ${{ secrets.NOTARY_KEY_ID }}
        run: |
          set -euo pipefail
          mkdir -p ~/.appstoreconnect/private_keys
          echo -n "$NOTARY_KEY_P8" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${NOTARY_KEY_ID}.p8 || {
            echo "::error::Failed to setup notarization credentials. Check NOTARY_KEY_P8."
            exit 1
          }
          echo "âœ… Notarization credentials configured"

      # 9. Notarize App
      - name: Notarize App
        env:
          NOTARY_KEY_ID: ${{ secrets.NOTARY_KEY_ID }}
          NOTARY_ISSUER_ID: ${{ secrets.NOTARY_ISSUER_ID }}
        run: |
          set -euo pipefail

          # Create ZIP for notarization
          ditto -c -k --keepParent build/export/Votra.app Votra-notarize.zip

          # Submit for notarization (15m timeout - typical is 2-5 minutes)
          echo "Submitting app for notarization..."
          xcrun notarytool submit Votra-notarize.zip \
            --key ~/.appstoreconnect/private_keys/AuthKey_${NOTARY_KEY_ID}.p8 \
            --key-id "$NOTARY_KEY_ID" \
            --issuer "$NOTARY_ISSUER_ID" \
            --wait --timeout 15m || {
            echo "::error::App notarization failed. Check Apple Developer System Status if timeout."
            exit 1
          }

          # Staple notarization ticket
          xcrun stapler staple build/export/Votra.app || {
            echo "::error::Failed to staple notarization ticket to app."
            exit 1
          }

          rm Votra-notarize.zip
          echo "âœ… App notarized and stapled successfully"

      # 10. Create DMG
      - name: Create DMG
        env:
          NOTARY_KEY_ID: ${{ secrets.NOTARY_KEY_ID }}
          NOTARY_ISSUER_ID: ${{ secrets.NOTARY_ISSUER_ID }}
        run: |
          set -euo pipefail

          DMG_NAME="${{ steps.version.outputs.dmg_name }}"

          # Create temp DMG
          hdiutil create -size 200m -fs HFS+ -volname "Votra" build/temp.dmg || {
            echo "::error::Failed to create temporary DMG."
            exit 1
          }

          # Mount DMG
          hdiutil attach build/temp.dmg -mountpoint /Volumes/Votra

          # Copy app and create Applications symlink
          cp -R build/export/Votra.app /Volumes/Votra/
          ln -s /Applications /Volumes/Votra/Applications

          # Unmount with retry (handles EBUSY from Spotlight/XProtect)
          for i in {1..5}; do
            hdiutil detach /Volumes/Votra && break || sleep $((i * 2))
          done

          # Convert to compressed ULFO format (LZFSE compression)
          hdiutil convert build/temp.dmg -format ULFO \
            -o "build/$DMG_NAME" || {
            echo "::error::Failed to convert DMG to compressed format."
            exit 1
          }
          rm build/temp.dmg

          # Sign DMG
          codesign -s "Developer ID Application" \
            --timestamp "build/$DMG_NAME" || {
            echo "::error::Failed to sign DMG."
            exit 1
          }

          # Notarize DMG (15m timeout)
          echo "Submitting DMG for notarization..."
          xcrun notarytool submit "build/$DMG_NAME" \
            --key ~/.appstoreconnect/private_keys/AuthKey_${NOTARY_KEY_ID}.p8 \
            --key-id "$NOTARY_KEY_ID" \
            --issuer "$NOTARY_ISSUER_ID" \
            --wait --timeout 15m || {
            echo "::error::DMG notarization failed."
            exit 1
          }

          # Staple DMG
          xcrun stapler staple "build/$DMG_NAME" || {
            echo "::error::Failed to staple notarization ticket to DMG."
            exit 1
          }

          echo "âœ… DMG created, signed, notarized, and stapled successfully"

      # 11. Generate checksums
      - name: Generate Checksums
        run: |
          set -euo pipefail
          cd build
          shasum -a 256 "${{ steps.version.outputs.dmg_name }}" > checksums.txt
          echo "Checksums:"
          cat checksums.txt

      # 12. Cleanup keychain (runs even on failure)
      - name: Cleanup Keychain
        if: always()
        run: |
          security delete-keychain build.keychain 2>/dev/null || true
          rm -rf ~/.appstoreconnect 2>/dev/null || true
          rm -f certificate.p12 2>/dev/null || true
          echo "âœ… Keychain cleanup complete"

      # 13. Create GitHub Release (as draft first)
      - name: Create Draft Release
        id: release
        uses: softprops/action-gh-release@v2
        with:
          name: Votra ${{ steps.version.outputs.version }}
          draft: true
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: true
          files: |
            build/${{ steps.version.outputs.dmg_name }}
            build/checksums.txt

      # 14. Publish Release (only if all previous steps succeeded)
      - name: Publish Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release edit "${{ github.ref_name }}" --draft=false
          echo "âœ… Release published successfully"

      # 15. Cleanup on Failure - delete tag and draft release
      - name: Cleanup on Failure
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "âš ï¸ Release failed, cleaning up..."
          # Delete draft release if it exists
          gh release delete "${{ github.ref_name }}" --yes 2>/dev/null || true
          # Delete the tag from remote
          git push origin :refs/tags/${{ github.ref_name }} 2>/dev/null || true
          echo "ğŸ—‘ï¸ Tag and draft release cleaned up"
          echo "::error::Release failed. Tag has been deleted. Fix the issue and push a new tag."

# Expected outputs:
# - GitHub Release created with tag name
# - Votra-X.Y.Z.dmg attached (signed + notarized)
# - checksums.txt attached
# - Release notes auto-generated
